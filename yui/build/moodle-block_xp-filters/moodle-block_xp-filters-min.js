YUI.add("moodle-block_xp-filters",function(i,e){var n,c="filter-add",t="filter",r="filters-list",a="rule",l="rule-rules",s=".filter-add",o=".filter-add a",d=".rule-add",u=".rule-add a",h="> .rule-add",g=".rule-rules .rule-definition",p=".filter-delete",f=".rule-delete",D=".filter",v=".filter-move",m=".filters-list",S=".filters-list > li",b=".rule",F=".rule-definition",k=".rule .rule-move",N=".rule-rules",T=function(){T.superclass.constructor.apply(this,arguments)};i.namespace("M.block_xp").Filters=i.extend(T,i.Base,{addFilterLink:null,canAddFilter:!1,container:null,filterDnD:null,rulepicker:null,rulesDnD:null,rulesetTarget:null,initializer:function(){this.container=i.one(this.get("containerSelector")),this.container.delegate("click",this.addNewFilter,o,this),this.container.delegate("click",this.addNewRule,u,this),this.container.delegate("click",this.deleteFilter,p,this),this.container.delegate("click",this.deleteRule,f,this),null!==this.container.one(s)&&(this.addFilterLink=this.container.one(s).cloneNode(!0),this.canAddFilter=!0),this.prepareRuleDialog(),this.filterDnD=i.namespace("M.block_xp.Filters.DnD").init({containerClass:r,containerSelector:this.get("containerSelector")+" "+m,groups:["filters_"+this.container.generateID()],handleSelector:v,nodeClass:t,nodeSelector:D}),this.filterDnD.on("drag:end",function(){this.fixFilterSortorder()},this),this.filterDnD.on("drop:over",function(){this.fixAddFilterLink()},this),this.rulesDnD={},this.container.all(D).each(function(e){this.setFilterRulesDnD(e)},this)},addNewFilter:function(e){var t=e.currentTarget.get("parentNode"),r=this.getNewFilterTemplate();e.preventDefault(),this.canAddFilter&&t.insert(this.addFilterLink.cloneNode(!0),"after"),t.insert(r,"after"),this.fixFilterSortorder(),this.filterDnD.syncTargets(),this.setFilterRulesDnD(r)},addNewRule:function(e){e.preventDefault(),this.rulepicker||this.prepareRuleDialog(),this.rulesetTarget=e.currentTarget.ancestor(b),this.rulepicker.display()},deleteFilter:function(e){e.preventDefault();var t=e.currentTarget.ancestor(D);t.remove(),delete this.rulesDnD[t.generateID()],this.fixFilterSortorder(),this.fixAddFilterLink()},deleteRule:function(e){var t;e.preventDefault(),(t=e.currentTarget.ancestor(b)).ancestor(b,!1,i.bind(function(e){return e==this.container},this))&&t.remove(!0)},fixAddFilterLink:function(){if(this.canAddFilter){var s,e=this.container.all(S),o=e.size();e.each(function(e,t){var r=e.hasClass(c),i=!s,n=e.getData("deleted"),a=!i&&s.hasClass(c),l=t-1==o;if(!n){if(i&&!r)e.insert(this.addFilterLink.cloneNode(!0),"before");else{if(!i&&a&&r)return void e.remove();i||a||r?l&&!r&&e.insert(this.addFilterLink.cloneNode(!0),"after"):e.insert(this.addFilterLink.cloneNode(!0),"before")}s=e}},this)}},fixFilterSortorder:function(){var e=this.container.all(D),i=0;e.each(function(e){var t=e.getData("basename"),r=e.one('input[name="'+t+'[sortorder]"]');r&&(r.setAttribute("value",i),i++)},this)},generateFilterBasename:function(e){return"filters["+e+"]"},generateRuleBasename:function(e,t){return e+"["+t+"]"},getNewFilterIncrement:function(){var e=this.container.all(D),i=0;return e.each(function(e){var t=e.getData("basename"),r=parseInt(/\[([0-9]+)\]$/.exec(t)[1]||0,10);i=i<r?r:i},this),i+1},getNewFilterTemplate:function(){var e=this.get("filter");return e=e.replace(this.get("filterTemplateBasename"),this.generateFilterBasename(this.getNewFilterIncrement())),i.Node.create(e)},getNewRuleIncrement:function(e){var t=e.all(g),i=0;return t.each(function(e){var t=e.getData("basename"),r=parseInt(/\[([0-9]+)\]$/.exec(t)[1]||0,10);i=i<r?r:i},this),i+1},newRulePicked:function(e,t){var r=this.get("rules")[t].template,i=this.rulesetTarget.one(N),n=this.generateRuleBasename(i.getData("basename"),this.getNewRuleIncrement(this.rulesetTarget));r=r.replace(this.get("ruleTemplateBasename"),n),i.insertBefore(r,i.one(h)),this.rulesDnD[i.ancestor(D).generateID()].syncTargets()},prepareRuleDialog:function(){var r=[];i.Object.each(this.get("rules"),function(e,t){r.push({id:t,name:e.name,info:e.info})},this),this.rulepicker=i.namespace("M.block_xp.RulePicker").init({rules:r}),this.rulepicker.on("picked",this.newRulePicked,this)},setFilterRulesDnD:function(e){e.one(N)&&(this.rulesDnD[e.generateID()]=i.namespace("M.block_xp.Filters.DnD").init({additionalDropsSelector:d,dropBeforeSelector:d,containerClass:l,containerSelector:"#"+e.generateID()+" "+N,groups:["rules_"+e.generateID()],handleSelector:k,nodeClass:a,nodeSelector:b}),this.rulesDnD[e.generateID()].on("drop:hit",function(e){var t=e.drag.get("node"),r=e.drop.get("node"),i=t.one(F).getData("basename"),n=r.ancestor(N,!0).getData("basename")+"["+this.getNewRuleIncrement(r.ancestor(b))+"]";t.all("[data-basename], [name]").each(function(e){e.hasAttribute("data-basename")&&e.setAttribute("data-basename",e.getAttribute("data-basename").replace(i,n)),e.hasAttribute("name")&&e.setAttribute("name",e.getAttribute("name").replace(i,n))},this)},this))}},{NAME:e,ATTRS:{containerSelector:{validator:i.Lang.isString,value:null},filter:{validator:i.Lang.isString,value:""},filterTemplateBasename:{value:/filters\[[0-9]+\]/g},rules:{validator:i.Lang.isObject,value:null},ruleTemplateBasename:{value:/XXXXX/g}}}),i.namespace("M.block_xp.Filters").init=function(e){return new T(e)},n=function(){n.superclass.constructor.apply(this,arguments)},i.namespace("M.block_xp.Filters").DnD=i.extend(n,M.core.dragdrop,{delegate:null,initializer:function(){var e,t;this.groups=this.get("groups"),this.samenodeclass=this.get("nodeClass"),this.parentnodeclass=this.get("containerClass"),(e=new i.DD.Delegate({container:this.get("containerSelector"),nodes:this.get("nodeSelector"),target:!0,handles:[this.get("handleSelector")],dragConfig:{groups:this.groups}})).dd.plug(i.Plugin.DDProxy,{moveOnEnd:!1,cloneNode:!0}),e.dd.plug(i.Plugin.DDConstrained,{constrain:this.get("containerSelector")}),e.dd.plug(i.Plugin.DDWinScroll),t=i.one(this.get("containerSelector")),e.createDrop(t,this.groups),this.delegate=e,this.publish(
"drag:end"),this.publish("drop:hit"),this.publish("drop:over"),this.syncTargets()},global_drop_over:function(e){if(e.drop&&e.drop.inGroup(this.groups)){var t=e.drag.get("node"),r=e.drop.get("node");this.lastdroptarget=e.drop,this.get("dropBeforeSelector")&&r.test(this.get("dropBeforeSelector"))?(r.get("parentNode").insertBefore(t,r),this.drop_over(e)):n.superclass.global_drop_over.apply(this,arguments)}},drag_end:function(e){this.fire("drag:end",e)},drop_hit:function(e){this.fire("drop:hit",e)},drop_over:function(e){this.fire("drop:over",e)},syncTargets:function(){this.delegate.syncTargets(),this.get("additionalDropsSelector")&&i.one(this.get("containerSelector")).all(this.get("additionalDropsSelector")).each(function(e){this.delegate.createDrop(e,this.groups)},this)}},{NAME:"block_xp-filters-dnd",ATTRS:{additionalDropsSelector:{validator:i.Lang.isString,value:null},containerClass:{validator:i.Lang.isString,value:null},containerSelector:{validator:i.Lang.isString,value:null},dropBeforeSelector:{validator:i.Lang.isString,value:null},groups:{validator:i.Lang.isArray,value:[]},handleSelector:{validator:i.Lang.isString,value:""},nodeClass:{validator:i.Lang.isString,value:null},nodeSelector:{validator:i.Lang.isString,value:null}}}),i.namespace("M.block_xp.Filters.DnD").init=function(e){return new n(e)}},"@VERSION@",{requires:["base","node","moodle-core-dragdrop","moodle-block_xp-rulepicker"]});