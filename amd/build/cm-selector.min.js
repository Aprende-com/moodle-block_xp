define(["jquery","core/ajax","block_xp/resource-selector","block_xp/cm-resource-selector"],function(a,b,c,d){function e(e,g){function h(){m.val(""),n.val(""),o.clear(),j.find(".cm-search").hide(),j.find(".course-search .course-not-selected").show(),j.find(".course-search .course-selected").hide(),k=null,m.focus()}function i(a){k=a,f=a,j.find(".course-search .course-selected span").text(a.fullname),j.find(".course-search .course-selected").show(),j.find(".course-search .course-not-selected").hide(),j.find(".cm-search").show(),o.clear(),p.initForCourse(a.id),n.val(""),n.focus()}g=g||f;var j=a(e),k=null,l=j.find(".search-result-contents"),m=j.find(".search-term-course"),n=j.find(".search-term-cm"),o=new c(l,function(a){var c=[{methodname:"block_xp_search_courses",args:{query:a}}];return b.call(c)[0].then(function(a){return a.map(function(a){return{_iscourse:!0,name:a.fullname,subname:a.shortname,course:a}})})},m);o.onResourceSelected(function(a,b){b._iscourse&&i(b.course)});var p=new d(l,n);p.onResourceSelected(function(a,b){b._iscm&&j.trigger("cm-selected",{cm:b.cm,course:k})}),j.find(".course-selection-change").on("click",function(){h()}),g?i(g):h()}var f=null;return{init:e}});